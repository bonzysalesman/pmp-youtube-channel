#!/usr/bin/env node

/**
 * Install PMP Admin Integration Plugin
 * Copies the mu-plugin to WordPress and activates it
 */

const fs = require('fs-extra');
const path = require('path');

async function installAdminIntegration() {
    console.log('üîß Installing PMP Admin Integration Plugin...\n');
    
    try {
        // Source and destination paths
        const sourcePath = path.join(__dirname, 'wordpress/mu-plugins/pmp-admin-integration.php');
        
        // Try different possible WordPress locations
        const possibleDestinations = [
            // Docker volume mount
            path.join(__dirname, 'wordpress_data/wp-content/mu-plugins/pmp-admin-integration.php'),
            // Direct WordPress installation
            path.join(__dirname, 'wp-content/mu-plugins/pmp-admin-integration.php'),
            // Alternative Docker mount
            path.join(__dirname, 'wordpress/wp-content/mu-plugins/pmp-admin-integration.php')
        ];
        
        let destPath = null;
        
        // Find the correct WordPress directory
        for (const dest of possibleDestinations) {
            const wpContentDir = path.dirname(path.dirname(dest));
            if (await fs.pathExists(wpContentDir) || await fs.pathExists(path.dirname(wpContentDir))) {
                destPath = dest;
                break;
            }
        }
        
        // If no WordPress directory found, create in project directory for manual copy
        if (!destPath) {
            destPath = path.join(__dirname, 'generated/mu-plugins/pmp-admin-integration.php');
            console.log('‚ö†Ô∏è  WordPress directory not found. Creating in generated/ for manual copy.');
        }
        
        // Check if source exists
        if (!await fs.pathExists(sourcePath)) {
            console.error('‚ùå Source plugin file not found:', sourcePath);
            return false;
        }
        
        // Ensure mu-plugins directory exists
        const muPluginsDir = path.dirname(destPath);
        await fs.ensureDir(muPluginsDir);
        
        // Copy the plugin file
        await fs.copy(sourcePath, destPath);
        
        console.log('‚úÖ Plugin copied to mu-plugins directory');
        console.log('üìÅ Location:', destPath);
        
        // Create a simple readme
        const readmePath = path.join(muPluginsDir, 'README.md');
        const readmeContent = `# PMP Course Admin Integration

This mu-plugin makes PMP course content visible in WordPress admin.

## Features

- Custom post type "Lessons" with full admin interface
- Lesson categories (weeks and domains) 
- Custom meta boxes for lesson details, ECO tasks, and statistics
- Course overview dashboard
- Cross-references management
- Custom admin columns with sorting

## Usage

The plugin is automatically active as an mu-plugin. No activation needed.

Access via:
- **Lessons**: Admin menu > PMP Course > All Lessons
- **Categories**: Admin menu > PMP Course > Categories  
- **Overview**: Admin menu > PMP Course > Course Overview
- **Cross References**: Admin menu > PMP Course > Cross References

## Generated by PMP Phase 1 Setup
`;
        
        await fs.writeFile(readmePath, readmeContent);
        
        console.log('\nüéâ Installation Complete!');
        
        if (destPath.includes('generated/')) {
            console.log('\nüìã MANUAL INSTALLATION REQUIRED:');
            console.log('   1. Copy the plugin file to your WordPress mu-plugins directory:');
            console.log(`      From: ${destPath}`);
            console.log('      To: /wp-content/mu-plugins/pmp-admin-integration.php');
            console.log('   2. Or use Docker exec to copy directly:');
            console.log('      docker exec pmp-wordpress mkdir -p /var/www/html/wp-content/mu-plugins');
            console.log(`      docker cp "${destPath}" pmp-wordpress:/var/www/html/wp-content/mu-plugins/`);
        } else {
            console.log('\nüìã Plugin installed automatically!');
        }
        
        console.log('\nüìã What you can now see in WordPress admin:');
        console.log('   ‚Ä¢ PMP Course menu in admin sidebar');
        console.log('   ‚Ä¢ All 41 lessons with custom columns');
        console.log('   ‚Ä¢ Lesson Categories (weeks and domains)');
        console.log('   ‚Ä¢ Custom meta boxes for lesson details');
        console.log('   ‚Ä¢ Course overview dashboard');
        console.log('   ‚Ä¢ Cross-references management');
        
        console.log('\nüîó Access your content at:');
        console.log('   ‚Ä¢ http://localhost:8080/wp-admin/edit.php?post_type=lesson');
        console.log('   ‚Ä¢ http://localhost:8080/wp-admin/edit-tags.php?taxonomy=lesson_category&post_type=lesson');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Installation failed:', error.message);
        return false;
    }
}

// Run installation
installAdminIntegration().then(success => {
    if (success) {
        console.log('\n‚úÖ Ready to use! Refresh your WordPress admin to see the changes.');
    } else {
        console.log('\n‚ùå Installation failed. Please check the errors above.');
        process.exit(1);
    }
});